// Generated by andromda-angular cartridge (view\view.component.imp.ts.vsl) CAN EDIT!
import { Component, Injector, ViewChildren } from '@angular/core';
import { ComplaintsAnalysisComponent } from '@app/view/complaint/complaints-analysis.component';
import { ComplaintState } from '@app/store/complaint/complaint.state';
import * as ComplaintSelectors from '@app/store/complaint/complaint.selectors';
import * as ComplaintActions from '@app/store/complaint/complaint.actions';
import { MatRadioChange } from '@angular/material/radio';
import { MatCheckboxChange } from '@angular/material/checkbox';
import { ComplaintVO } from '@app/model/bw/org/bocra/portal/complaint/complaint-vo';
import { ReportElementComponent } from '../report/report-element.component';
import { ReportRestController } from '@app/service/bw/org/bocra/portal/report/report-rest-controller';
import { saveAs } from 'file-saver';

@Component({
  selector: 'app-complaints-analysis',
  templateUrl: './complaints-analysis.component.html',
  styleUrls: ['./complaints-analysis.component.scss'],
})
export class ComplaintsAnalysisComponentImpl extends ComplaintsAnalysisComponent {
  @ViewChildren('reportElement')
  reportElementComponents!: ReportElementComponent[];
  complaintsDataSource = new Array<ComplaintVO>;
  reportController!: ReportRestController;
  constructor(private injector: Injector) {
    super(injector);
  }
  yearFilter: string[] = [];
  licenseeFilter: string[] = [];
  typeFilter: string[] = [];
  statusFilter: string[] = [];
  sectorFilter: string[] = [];
  borderColor = [
    'rgba(255, 99, 132)',
    'rgba(255, 159, 64)',
    'rgba(54, 162, 235)',
    'rgba(153, 102, 255)',
    'rgba(201, 203, 207)',
    'rgba(0, 172, 230)',
    'rgba(230, 0, 115)',
    'rgba(255, 51, 102)',
    'rgba(255, 51, 204)',
    'rgba(255, 140, 26)',
    'rgba(255, 140, 102)',
    'rgba(0, 204, 102)',
  ]
  backgroundColor = [
    'rgba(255, 99, 132, 0.5)',
    'rgba(255, 159, 64, 0.5)',
    'rgba(54, 162, 235, 0.5)',
    'rgba(153, 102, 255, 0.5)',
    'rgba(201, 203, 207, 0.5)',
    'rgba(0, 172, 230, 0.5)',
    'rgba(230, 0, 115, 0.5)',
    'rgba(255, 51, 102, 0.5)',
    'rgba(255, 51, 204, 0.5)',
    'rgba(255, 140, 26, 0.5)',
    'rgba(255, 140, 102, 0.5)',
    'rgba(0, 204, 102, 0.5)',
  ]
  hoverBackgroundColor = [
    'rgba(255, 99, 132)',
    'rgba(255, 159, 64)',
    'rgba(54, 162, 235)',
    'rgba(153, 102, 255)',
    'rgba(201, 203, 207)',
    'rgba(0, 172, 230)',
    'rgba(230, 0, 115)',
    'rgba(255, 51, 102)',
    'rgba(255, 51, 204)',
    'rgba(255, 140, 26)',
    'rgba(255, 140, 102)',
    'rgba(0, 204, 102)',
  ]
  override doNgAfterViewInit(): void {
    // this.yearFilter.push(
    //   this.useCaseScope.pageVariables.map((entry: { createdDate: string }) => entry.createdDate.substring(0, 4))
    // );
    // this.reportLabel = [...new Set(this.yearFilter[0])];


    this.complaintsDataSource = this.useCaseScope.pageVariables;

    for (let complaint of this.complaintsDataSource) {
      this.yearFilter.push(complaint.createdDate[0]);
    }

    this.reportLabel = [...new Set(this.yearFilter)];
    console.log(this.reportLabel);

    for (let year of this.reportLabel) {
      let total = 0;
      for (let complaint of this.complaintsDataSource) {
        if (complaint.createdDate[0] == year) {
          total = total + 1;
        }
      }
      this.reportData.push(total);
    }
  
    this.barChartData.datasets = [
      {
        data: this.reportData,
        label: 'Complaints Per Year Analysis',
        backgroundColor: this.backgroundColor,
        borderColor: this.borderColor,
        hoverBackgroundColor: this.hoverBackgroundColor
      },
    ];
    this.pieChartData.datasets = [{ data: this.reportData, label: 'Complaints Report Analysis' }];

    this.barChartData.labels = this.reportLabel;
    this.pieChartData.labels = this.reportLabel;

    this.licenseeFilter.push(
      this.useCaseScope.pageVariables.map((entry: { licensee: { licenseeName: any } }) => entry.licensee.licenseeName)
    );
    this.reportLicenseesLabel = [...new Set(this.licenseeFilter[0])];
    for (let licensee of this.reportLicenseesLabel) {
      let data = this.useCaseScope.pageVariables.filter((entry: { licensee: { licenseeName: string | string[] } }) =>
        entry.licensee.licenseeName.includes(licensee)
      ).length;
      this.reportLicenseesData.push(data);
    }

    this.barChartLicenseeData.datasets = [
      {
        data: this.reportLicenseesData,
        label: 'Complaints Per Year Analysis',
        backgroundColor: this.backgroundColor,
        borderColor: this.borderColor,
        hoverBackgroundColor: this.hoverBackgroundColor
      },
    ];
    this.pieChartLicenseeData.datasets = [{ data: this.reportLicenseesData, label: 'Licensee Complaints Analysis' }];

    this.barChartLicenseeData.labels = this.reportLicenseesLabel;
    this.pieChartLicenseeData.labels = this.reportLicenseesLabel;

    this.typeFilter.push(
      this.useCaseScope.pageVariables.map((entry: { complaintType: { typeName: any } }) => entry.complaintType.typeName)
    );
    this.reportTypeLabel = [...new Set(this.typeFilter[0])];

    for (let type of this.reportTypeLabel) {
      let data = this.useCaseScope.pageVariables.filter((entry: { complaintType: { typeName: any } }) =>
        entry.complaintType.typeName.includes(type)
      ).length;
      this.reportTypeData.push(data);
    }

    this.barChartTypeData.datasets = [
      {
        data: this.reportTypeData,
        label: 'Complaints Per Complaint Type Analysis',
        backgroundColor: this.backgroundColor,
        borderColor: this.borderColor,
        hoverBackgroundColor: this.hoverBackgroundColor
      },
    ];
    this.pieChartTypeData.datasets = [{ data: this.reportTypeData, label: 'Complaint Type Complaints Analysis' }];

    this.barChartTypeData.labels = this.reportTypeLabel;
    this.pieChartTypeData.labels = this.reportTypeLabel;

    this.statusFilter.push(
      this.useCaseScope.pageVariables.map((entry: { status: string }) => entry.status)
    );
    this.reportStatusLabel = [...new Set(this.statusFilter[0])];
    for (let status of this.reportStatusLabel) {
      let data = this.useCaseScope.pageVariables.filter((entry: { status: string | string[] }) =>
        entry.status.includes(status)).length;
      this.reportStatusData.push(data);
    }

    this.barChartStatusData.datasets = [
      {
        data: this.reportStatusData,
        label: 'Complaints Per Status Analysis',
        backgroundColor: this.backgroundColor,
        borderColor: this.borderColor,
        hoverBackgroundColor: this.hoverBackgroundColor
      },
    ];
    this.pieChartStatusData.datasets = [{ data: this.reportStatusData, label: 'Complaints Report Analysis' }];

    this.barChartStatusData.labels = this.reportStatusLabel;
    this.pieChartStatusData.labels = this.reportStatusLabel;

    for (let complaint of this.useCaseScope.pageVariables) {
      for (let sector of complaint.licensee.sectors) {
        this.sectorFilter.push(sector.sector.name);
      }
    }
    this.reportSectorLabel = [...new Set(this.sectorFilter)];

    for (let sectorName of this.reportSectorLabel) {
      let total = 0;
      for (let complaint of this.useCaseScope.pageVariables) {
        for (let sector of complaint.licensee.sectors) {
          if (sector.sector.name.includes(sectorName)) {
            total = total + 1;
          }
        }
      }
      this.reportSectorData.push(total);
    }

    this.barChartSectorData.datasets = [
      {
        data: this.reportSectorData,
        label: 'Complaints Per Sector Analysis',
        backgroundColor: this.backgroundColor,
        borderColor: this.borderColor,
        hoverBackgroundColor: this.hoverBackgroundColor
      },
    ];
    this.pieChartSectorData.datasets = [{ data: this.reportSectorData, label: 'Sector Complaints Analysis' }];

    this.barChartSectorData.labels = this.reportSectorLabel;
    this.pieChartSectorData.labels = this.reportSectorLabel;

  }

  downloadFormReport() {
    let d: any = {};

    d = {
      reportName: this.reportFilterForm.value.chartLabel,
      images: [
        {
          label: this.reportFilterForm.value.chartLabel,
          image: this.chart.toBase64Image(),
          caption: this.reportFilterForm.value.chartCaption
        }
      ]
    }
    console.log(d);

    this.reportController.createComplaintReportWordDocument(d).subscribe(file => {
      if (file) {

        let blob: any = file as Blob;
        const url = window.URL.createObjectURL(blob);
        saveAs(blob, `${d.reportName}.docx`);
      }
    });
  }

  doNgOnDestroy(): void { }
}
