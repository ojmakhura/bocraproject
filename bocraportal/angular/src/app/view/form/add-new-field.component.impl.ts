// Generated by andromda-angular cartridge (view\view.component.imp.ts.vsl) CAN EDIT!
import { Component, Injector } from '@angular/core';
import { AddNewFieldComponent } from '@app/view/form/add-new-field.component';
import { AddNewFieldAddExpressionForm } from '@app/view/form/add-new-field.component';
import { AddNewFieldCancelForm } from '@app/view/form/add-new-field.component';
import { AddNewFieldDoneForm } from '@app/view/form/add-new-field.component';
import { AddNewFieldSaveForm } from '@app/view/form/add-new-field.component';
import { AddNewFieldVarsForm } from '@app/view/form/add-new-field.component';
import { FormState } from '@app/store/form/form.state';
import * as FormSelectors from '@app/store/form/form.selectors';
import * as FormActions from '@app/store/form/form.actions';
import { MatRadioChange } from '@angular/material/radio';
import { MatCheckboxChange } from '@angular/material/checkbox';
import { ExpressionVO } from '@app/model/bw/org/bocra/portal/expression/expression-vo';
import { FormVO } from '@app/model/bw/org/bocra/portal/form/form-vo';
import { FormSectionVO } from '@app/model/bw/org/bocra/portal/form/section/form-section-vo';
import { FormFieldVO } from '@model/bw/org/bocra/portal/form/field/form-field-vo';
import { SelectItem } from '@app/utils/select-item';
import { Observable } from 'rxjs';
import { select } from '@ngrx/store';
import { KeycloakService } from 'keycloak-angular';

@Component({
  selector: 'app-add-new-field',
  templateUrl: './add-new-field.component.html',
  styleUrls: ['./add-new-field.component.scss'],
})
export class AddNewFieldComponentImpl extends AddNewFieldComponent {

  form$: Observable<FormVO>;
  protected keycloakService: KeycloakService;

  constructor(private injector: Injector) {
    super(injector);
    this.form$ = this.store.pipe(select(FormSelectors.selectForm));
    this.keycloakService = injector.get(KeycloakService);
  }

  override beforeOnInit(form: AddNewFieldVarsForm): AddNewFieldVarsForm {
    if (this.useCaseScope?.pageVariables['form']) {
      const f: FormVO = this.useCaseScope?.pageVariables['form'];

      f?.formSections?.forEach((element: FormSectionVO) => {
        let item: SelectItem = new SelectItem();
        item.label = element.sectionName;
        item.value = element;

        this.formFieldFormSectionBackingList.push(item);
      });

      if (!form?.formField) {
        form.formField = new FormFieldVO();
      }

      form.formField.form = f;
    }

    return form;
  }

  override doNgOnDestroy(): void {
  }

  override doNgAfterViewInit() {
    this.route.queryParams.subscribe((queryParams: any) => {
      if (queryParams?.id) {
        this.store.dispatch(FormActions.findFieldById({ id: queryParams.id, loading: true }));

        this.form$.subscribe((f) => {
          this.formFieldFormControl.patchValue(f);
          this.formFieldFormSectionBackingList = [];
          f?.formSections?.forEach((element: FormSectionVO) => {
            let item: SelectItem = new SelectItem();
            item.label = element.sectionName;
            item.value = element;
    
            this.formFieldFormSectionBackingList.push(item);
          });
        });
      } else {
        if (queryParams?.formId) {
          this.store.dispatch(FormActions.findFormById({ id: queryParams.formId, loading: true }));
          
          this.form$.subscribe((f) => {
            this.formFieldFormControl.patchValue(f);
            this.formFieldFormSectionBackingList = []
            f?.formSections?.forEach((element: FormSectionVO) => {
              let item: SelectItem = new SelectItem();
              item.label = element.sectionName;
              item.value = element;
      
              this.formFieldFormSectionBackingList.push(item);
            });
          });
        }
      }
    });
  }

  /**
   * This method may be overwritten
   */
  override beforeAddNewFieldCancel(form: AddNewFieldCancelForm): void {
    this.useCaseScope.pageVariables['form'] = form.formFieldForm;
    this.useCaseScope.queryParams['id'] = form.formFieldForm.id;
  }

  /**
   * This method may be overwritten
   */
  override beforeAddNewFieldDone(form: AddNewFieldDoneForm): void {
    this.useCaseScope.pageVariables['form'] = this.formFieldForm;
    this.useCaseScope.queryParams['id'] = this.formFieldForm.id;
  }

  /**
   * This method may be overwritten
   */
  override beforeAddNewFieldSave(form: AddNewFieldSaveForm): void {
    
    if (this.formFieldControl.dirty && this.formFieldControl.valid) {
      if (this.formField.id) {
        this.formField.updatedBy = this.keycloakService.getUsername();
        this.formField.updatedDate = new Date();
      } else {
        this.formField.createdBy = this.keycloakService.getUsername();
        this.formField.createdDate = new Date();
      }

      this.store.dispatch(
        FormActions.saveField({
          formField: this.formField,
          loading: true,
        })
      );
    } else {
      this.store.dispatch(FormActions.formFailure({ messages: ['Form has and error!'] }));
    }
  }
}
