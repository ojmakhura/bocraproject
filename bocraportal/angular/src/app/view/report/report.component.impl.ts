// Generated by andromda-angular cartridge (view\view.component.imp.ts.vsl) CAN EDIT!
import { Component, Injector } from '@angular/core';
import { ReportComponent } from '@app/view/report/report.component';
import * as SubmissionActions from '@app/store/form/submission/form-submission.actions';
import * as SubmissionSelectors from '@app/store/form/submission/form-submission.selectors';
import * as ViewActions from '@app/store/view/view.actions';
import * as ViewSelectors from '@app/store/view/view.selectors';
import { Observable } from 'rxjs';
import { FormSubmissionVO } from '@app/model/bw/org/bocra/portal/form/submission/form-submission-vo';
import { select } from '@ngrx/store';
import { FormArray, FormGroup } from '@angular/forms';

@Component({
  selector: 'app-report',
  templateUrl: './report.component.html',
  styleUrls: ['./report.component.scss'],
})
export class ReportComponentImpl extends ReportComponent {

  submissions$: Observable<FormSubmissionVO[]>;
  submissions: FormSubmissionVO[] = [];
  licensees: string[] = [];

  constructor(private injector: Injector) {
    super(injector);
    this.submissions$ = this.store.pipe(select(SubmissionSelectors.selectFormSubmissions));
  }

  doNgOnDestroy(): void {}

  override doNgAfterViewInit() {

    this.route.queryParams.subscribe((queryParams: any) => {
      let ids = queryParams.submissions.map((id: string) => +id);
      this.store.dispatch(
        SubmissionActions.findByIds({
          ids: ids,
          loaderMessage: `Loading ${ids.length} submissions for report generation ....`,
          loading: true,
        })
      );
    });

    this.submissions$.subscribe(submissions => {
      this.submissions = submissions;
      this.licensees = [...new Set(submissions.map(submission => submission.licensee.licenseeName))];
    });
  }

  override afterOnInit(): void {
  }

  getReportElementControl(): FormGroup {
    return this.formBuilder.group({
      element: []
    });
  }

  addReportElement() {
    this.reportElements.push(
      this.getReportElementControl()
    );
  }

  override newForm(): FormGroup {
      return this.formBuilder.group({
        reportElements: this.formBuilder.array([this.getReportElementControl()])
      });
  }

  get reportElements(): FormArray {
    return this.reportForm.get('reportElements') as FormArray;
  }

  removeReportElement(i: number) {
    this.reportElements.removeAt(i);
  }
}
